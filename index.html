import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, RotateCcw, Bell, Sparkles } from 'lucide-react';

const PomodoroTimer = () => {
  // 狀態管理
  const [customMinutes, setCustomMinutes] = useState(25); // 使用者設定的分鐘數
  const [timeLeft, setTimeLeft] = useState(25 * 60); // 實際倒數秒數
  const [isActive, setIsActive] = useState(false);
  const [permission, setPermission] = useState('default');
  
  // 音效 Ref (使用免費的輕柔提示音)
  const audioRef = useRef(null);

  // 初始化音效 (移除自動請求權限，改為被動觸發)
  useEffect(() => {
    // 初始化音效物件
    audioRef.current = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
    
    // 檢查目前權限狀態，但不主動請求
    if ('Notification' in window) {
      setPermission(Notification.permission);
    }

    return () => {
      // 組件卸載時清理音效
      if (audioRef.current) {
        audioRef.current.pause();
        audioRef.current = null;
      }
    };
  }, []);

  // 更新瀏覽器標題與倒數計時邏輯
  useEffect(() => {
    let interval = null;

    // 更新網頁標題
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    // 更新標題名稱為 "靜謐時光"
    document.title = isActive ? `(${formattedTime}) 靜謐時光` : '靜謐時光';

    if (isActive && timeLeft > 0) {
      interval = setInterval(() => {
        setTimeLeft((prevTime) => prevTime - 1);
      }, 1000);
    } else if (timeLeft === 0) {
      handleFinish();
    }

    return () => clearInterval(interval);
  }, [isActive, timeLeft]);

  // 請求通知權限的函數 (使用者互動時呼叫)
  const requestNotificationPermission = async () => {
    if ('Notification' in window && permission === 'default') {
      const perm = await Notification.requestPermission();
      setPermission(perm);
    }
  };

  // 處理時間結束
  const handleFinish = () => {
    setIsActive(false);
    
    if (audioRef.current) {
      audioRef.current.play().catch(e => console.error("Audio play failed (browser policy):", e));
    }

    if (permission === 'granted') {
      try {
        new Notification("靜謐時光", {
          body: "此刻，深呼吸，感受當下。",
          icon: "https://cdn-icons-png.flaticon.com/512/3655/3655589.png" // 蓮花或禪意圖示
        });
      } catch (e) {
        console.error("Notification failed:", e);
      }
    }
  };

  // 格式化時間顯示 (MM:SS)
  const formatTime = (seconds) => {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  };

  // 處理使用者輸入時間
  const handleTimeChange = (e) => {
    const val = parseInt(e.target.value, 10);
    // 限制輸入範圍 1 ~ 180 分鐘
    if (!isNaN(val) && val > 0 && val <= 180) {
      setCustomMinutes(val);
      if (!isActive) {
        setTimeLeft(val * 60);
      }
    } else if (e.target.value === '') {
       // 允許暫時清空以便輸入
       setCustomMinutes('');
    }
  };

  // 按鈕功能
  const toggleTimer = () => {
    // 首次點擊開始時，請求通知權限
    if (!isActive && permission === 'default') {
      requestNotificationPermission();
    }

    // 如果輸入欄位是空的或不合法，恢復預設值
    if (customMinutes === '' || customMinutes <= 0) {
      setCustomMinutes(25);
      setTimeLeft(25 * 60);
    }
    
    setIsActive(!isActive);
    
    // 預先加載音效以避免移動端延遲
    if (!isActive && audioRef.current) {
      audioRef.current.load(); 
    }
  };

  const resetTimer = () => {
    setIsActive(false);
    // 重置為使用者目前設定的時間
    const mins = customMinutes === '' ? 25 : customMinutes;
    setTimeLeft(mins * 60);
  };

  // 背景圖片 URL (靜思/禪意風格：疊石與水面)
  const bgImage = "https://images.unsplash.com/photo-1518176258769-f227c798150e?q=80&w=2688&auto=format&fit=crop";

  return (
    <div 
      // 使用 min-h-[100dvh] 確保在手機瀏覽器上高度正確，不會因為網址列伸縮而跳動
      className="min-h-screen h-[100dvh] w-full flex items-center justify-center bg-cover bg-center bg-no-repeat relative overflow-hidden font-sans"
      style={{ backgroundImage: `url(${bgImage})` }}
    >
      {/* 遮罩加強，營造沉穩感 */}
      <div className="absolute inset-0 bg-stone-900/50 backdrop-blur-sm"></div>

      {/* 主卡片 */}
      <div className="relative z-10 p-10 md:p-14 rounded-[2rem] bg-stone-800/20 border border-stone-300/10 shadow-2xl backdrop-blur-xl text-stone-100 max-w-md w-full mx-4 flex flex-col items-center animate-fade-in-up">
        
        {/* 標題與圖示 (更新名字與排版) */}
        <div className="flex flex-col items-center mb-8 opacity-90">
          <div className="flex items-center gap-3 mb-2">
            <Sparkles className="w-5 h-5 text-teal-200/80" />
            <h1 className="text-3xl font-light tracking-[0.3em] text-stone-100 shadow-sm">靜謐時光</h1>
          </div>
          <span className="text-[10px] tracking-[0.4em] text-stone-400 uppercase pl-2">Serene Moments</span>
        </div>

        {/* 時間顯示 */}
        <div className="mb-8 font-light text-8xl md:text-9xl tracking-tight drop-shadow-2xl tabular-nums text-white">
          {formatTime(timeLeft)}
        </div>

        {/* 自訂時間輸入區 (僅在非倒數狀態下顯示/可編輯) */}
        <div className="mb-10 flex items-center justify-center gap-3 text-stone-300/80 transition-opacity duration-300">
          <label htmlFor="custom-minutes" className="text-sm tracking-widest font-light">
            設定時間 (分)
          </label>
          <input
            id="custom-minutes"
            type="number"
            min="1"
            max="180"
            value={customMinutes}
            onChange={handleTimeChange}
            disabled={isActive}
            // 寬度從 w-16 增加到 w-20 以適應不同字體
            className="w-20 bg-transparent border-b border-stone-400/50 text-center text-xl focus:outline-none focus:border-teal-400 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          />
        </div>

        {/* 控制按鈕區 */}
        <div className="flex items-center gap-8 w-full justify-center">
          
          {/* 開始/暫停按鈕 */}
          <button
            onClick={toggleTimer}
            className={`group flex items-center justify-center w-20 h-20 rounded-full transition-all duration-500 shadow-xl hover:scale-105 active:scale-95 ${
              isActive 
                ? 'bg-stone-200/90 text-stone-800 hover:bg-white' 
                : 'bg-teal-700/80 hover:bg-teal-600/90 text-white'
            }`}
            aria-label={isActive ? "暫停" : "開始"}
          >
            {isActive ? (
              <Pause className="w-8 h-8 fill-current" />
            ) : (
              <Play className="w-8 h-8 fill-current ml-1" />
            )}
          </button>

          {/* 重置按鈕 */}
          <button
            onClick={resetTimer}
            className="flex items-center justify-center w-14 h-14 rounded-full bg-stone-500/20 hover:bg-stone-500/40 text-stone-200 transition-all duration-500 hover:rotate-180 active:scale-90 backdrop-blur-md border border-white/5"
            aria-label="重置"
            title="重置計時器"
          >
            <RotateCcw className="w-6 h-6 opacity-80" />
          </button>
        </div>

        {/* 狀態提示文字 */}
        <div className="mt-10 h-6 text-center text-stone-300/60 font-light tracking-widest text-xs">
          {timeLeft === 0 ? (
            <span className="flex items-center gap-2 text-teal-200 animate-pulse">
              <Bell className="w-3 h-3" /> 靜心時間結束
            </span>
          ) : isActive ? (
            "專注當下 · 心無旁鶩"
          ) : (
            "調整呼吸 · 準備開始"
          )}
        </div>
      </div>

      {/* 底部版權/說明 */}
      <div className="absolute bottom-6 text-stone-400/30 text-[10px] tracking-[0.3em] uppercase">
        Mindfulness Timer
      </div>

      <audio ref={audioRef} preload="auto" />
      
      <style>{`
        /* 移除 input number 的箭頭 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        
        @keyframes fade-in-up {
          0% { opacity: 0; transform: translateY(20px); }
          100% { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
          animation: fade-in-up 1s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
      `}</style>
    </div>
  );
};

export default PomodoroTimer;